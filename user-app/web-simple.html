<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Link User App</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8fafc;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .title {
            color: #1877F2;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .sensor-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .sensor-card:hover {
            transform: translateY(-2px);
        }
        
        .sensor-card.good {
            border-left: 4px solid #28a745;
        }
        
        .sensor-card.warning {
            border-left: 4px solid #ffc107;
        }
        
        .sensor-card.danger {
            border-left: 4px solid #dc3545;
        }
        
        .sensor-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1877F2;
            margin-bottom: 10px;
        }
        
        .sensor-unit {
            color: #666;
            font-size: 1rem;
        }
        
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .status.good {
            background: #d4edda;
            color: #155724;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .device-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .device-item:last-child {
            border-bottom: none;
        }
        
        .device-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .device-location {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .device-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .device-status.active {
            background: #d4edda;
            color: #155724;
        }
        
        .device-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .refresh-btn {
            background: #1877F2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: #166fe5;
        }
        
        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API 클라이언트
        const API_BASE_URL = 'http://localhost:3000';
        
        const FarmLinkAPI = {
            async getLatestSensorData(deviceId = 'farmlink-001') {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/sensor-data?device_id=${deviceId}&limit=1`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.success && data.data && data.data.length > 0 ? data.data[0] : null;
                    }
                    return null;
                } catch (error) {
                    console.error('센서 데이터 조회 실패:', error);
                    return null;
                }
            },
            
            async getDevices() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/devices`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.success && data.data ? data.data : [];
                    }
                    return [];
                } catch (error) {
                    console.error('디바이스 목록 조회 실패:', error);
                    return [];
                }
            }
        };

        // 센서 카드 컴포넌트
        function SensorCard({ title, icon, valueKey, unit, type, deviceId }) {
            const [sensorData, setSensorData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const getStatusColor = (value, type) => {
                switch (type) {
                    case 'moisture':
                        return value < 20 ? 'danger' : value < 50 ? 'warning' : 'good';
                    case 'temperature':
                        return value > 35 ? 'danger' : value > 30 ? 'warning' : 'good';
                    case 'humidity':
                        return value > 80 ? 'danger' : value > 70 ? 'warning' : 'good';
                    case 'light':
                        return value > 80 ? 'danger' : value > 60 ? 'warning' : 'good';
                    default:
                        return 'good';
                }
            };

            const getStatusText = (value, type) => {
                switch (type) {
                    case 'moisture':
                        return value < 20 ? '건조' : value < 50 ? '보통' : '적정';
                    case 'temperature':
                        return value > 35 ? '높음' : value > 30 ? '보통' : '적정';
                    case 'humidity':
                        return value > 80 ? '높음' : value > 70 ? '보통' : '적정';
                    case 'light':
                        return value > 80 ? '강함' : value > 60 ? '보통' : '적정';
                    default:
                        return '정상';
                }
            };

            const fetchData = async () => {
                try {
                    setError(null);
                    const data = await FarmLinkAPI.getLatestSensorData(deviceId);
                    setSensorData(data);
                } catch (err) {
                    setError('데이터 로딩 실패');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [deviceId]);

            if (loading) {
                return (
                    <div className="sensor-card">
                        <div className="sensor-title">{icon} {title}</div>
                        <div className="loading">로딩 중...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="sensor-card">
                        <div className="sensor-title">{icon} {title}</div>
                        <div className="error">{error}</div>
                    </div>
                );
            }

            const value = sensorData?.[valueKey];
            const status = typeof value === 'number' ? getStatusColor(value, type) : 'good';
            const statusText = typeof value === 'number' ? getStatusText(value, type) : '정상';

            return (
                <div className={`sensor-card ${status}`}>
                    <div className="sensor-title">{icon} {title}</div>
                    <div className="sensor-value">
                        {typeof value === 'number' ? value.toFixed(1) : '--'}
                        <span className="sensor-unit">{unit}</span>
                    </div>
                    <div className={`status ${status}`}>{statusText}</div>
                </div>
            );
        }

        // 메인 앱 컴포넌트
        function App() {
            const [devices, setDevices] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);

            const fetchDevices = async () => {
                try {
                    setLoading(true);
                    const deviceList = await FarmLinkAPI.getDevices();
                    setDevices(deviceList);
                } catch (error) {
                    console.error('디바이스 목록 조회 실패:', error);
                } finally {
                    setLoading(false);
                }
            };

            const onRefresh = async () => {
                setRefreshing(true);
                await fetchDevices();
                setRefreshing(false);
            };

            useEffect(() => {
                fetchDevices();
            }, []);

            return (
                <div className="container">
                    <div className="header">
                        <h1 className="title">🌱 Farm Link</h1>
                        <p className="subtitle">스마트팜 모니터링 시스템</p>
                    </div>

                    <div className="sensor-grid">
                        <SensorCard
                            title="토양 수분"
                            icon="💧"
                            valueKey="soil_moisture"
                            unit="%"
                            type="moisture"
                            deviceId="farmlink-001"
                        />
                        <SensorCard
                            title="온도"
                            icon="🌡️"
                            valueKey="temperature"
                            unit="°C"
                            type="temperature"
                            deviceId="farmlink-001"
                        />
                        <SensorCard
                            title="습도"
                            icon="💨"
                            valueKey="humidity"
                            unit="%"
                            type="humidity"
                            deviceId="farmlink-001"
                        />
                        <SensorCard
                            title="조도"
                            icon="☀️"
                            valueKey="light_intensity"
                            unit="ph"
                            type="light"
                            deviceId="farmlink-001"
                        />
                    </div>

                    <div className="device-card">
                        <h2 style={{ marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            📱 디바이스 상태
                        </h2>
                        
                        {devices.length > 0 ? (
                            devices.map((device) => (
                                <div key={device.id} className="device-item">
                                    <div>
                                        <div className="device-name">{device.name}</div>
                                        <div className="device-location">{device.location}</div>
                                    </div>
                                    <div className={`device-status ${device.status === 'active' ? 'active' : 'inactive'}`}>
                                        {device.status === 'active' ? '정상' : '비활성'}
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="loading">
                                <div style={{ fontSize: '48px', marginBottom: '12px' }}>❓</div>
                                등록된 디바이스가 없습니다
                            </div>
                        )}
                    </div>

                    <button 
                        className="refresh-btn" 
                        onClick={onRefresh} 
                        disabled={refreshing}
                    >
                        {refreshing ? '새로고침 중...' : '🔄 새로고침'}
                    </button>
                </div>
            );
        }

        // 앱 렌더링
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
